<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Chain Plotter</title>
	
	<style>
    canvas { 
        background: lightgray;  /* Or any contrasting color */
        border: 1px solid black;
    }
    </style>
<script type="module" defer> 
	import {setupUI,updateUI,setupSlider,makeSlider,makeCheckbox} from "./webgl_lessons_ui.module.js"
	
	window.webglLessonsUI={
    setupUI: setupUI,
    updateUI: updateUI,
    setupSlider: setupSlider,
    makeSlider: makeSlider,
    makeCheckbox: makeCheckbox,
  };
  console.log(Object.keys(webglLessonsUI));
  function debugLog(obj) {
    const logElement = document.getElementById('debugLogText');
    logElement.innerHTML +=  JSON.stringify(obj)+ '<br>';
    logElement.scrollTop = logElement.scrollHeight; // Auto scroll to bottom
};
</script>
</head>
<body>
<div>
    <canvas id="arcCanvas" width="500" height="500"></canvas>
  <!-- Add this to your HTML body -->
<div id="debugLogText" style="position: absolute; top: 0; right: 0; width: 50%; height: 100%; overflow-y: scroll; background: white; color: black;"></div>
</div>
<input type="file" id="file-input" />
<select name="outline-selector" id="outline-selector"></select>


<h3>Contents of the file:</h3>
<pre id="file-content"></pre>
<script type="module">
	import {plot_segments,SegmentsLengthArea,TurtlePathLengthArea} from './turtle.js';
	import {stringifyFormatted} from './json_utils.js';
	window.plot_segments=plot_segments;
	window.SegmentsLengthArea=SegmentsLengthArea;
	window.TurtlePathLengthArea=TurtlePathLengthArea;
	window.stringifyFormatted=stringifyFormatted;
	console.log("in Module1");
</script>

<script>
const deg=Math.PI/180;
const rad2deg=1/deg;
var targetAngleRadians;
let targetRadius=10;
const target=[null,null,null];

function updateTargetAngle(event, ui) {
    targetAngleRadians = ui.value*deg;
    target[0] = Math.sin(targetAngleRadians) * targetRadius;
    target[2] = Math.cos(targetAngleRadians) * targetRadius;
//    drawScene();
  }

</script>
<script type="module">
webglLessonsUI.setupSlider("#targetAngle", {value: targetAngleRadians*rad2deg, slide: updateTargetAngle, min: -360, max: 360});

</script>
<script>
function formatFloat(num, decimalPlaces) {
  return num.toFixed(decimalPlaces);
}

function deepCopyArray(arr) {
    return arr.map(item => Array.isArray(item) ? deepCopyArray(item) : item);
}

// Initialization code

var filename = "readme.txt";
var text = "Text of the file goes here.";
var blob = new Blob([text], {type:'text/gcode'});
var link = document.createElement("a");
link.download = filename;
link.innerHTML = "Download File";
link.href = window.URL.createObjectURL(blob);
document.body.appendChild(link)
    </script>
<script id="main" type="text/javascript">
let cookieCutterArea=2000;
let outlines={
    "Duck": [
      [ 0.4, -10.0 ],
      [ 13.297, 25.0 ],
      [ 3, -80.0 ],
      [ 4, 160.0 ],
      [ 22.913, 90.0 ],
      [ 15, 90.0 ],
      [ 5, -90.0 ],
      [ 5, 20.0 ],
      [ 3, 170.0 ],
      [ 2, -20.0 ],
      [ 3, -90.0 ],
      [ 15, 220.0 ],
      [ 5, -125.0 ]
    ]
    };
let  brickworks={
    "centered": [
      [ [ -0.45, 0.9 ], [ -1.35, 0.9 ], [ 0.45, 0.9 ], [ 1.35, 0.9 ] ],
      [ [ -0.8, 0.8 ], [ -1.6, 0.8 ], [ 0.8, 0.8 ], [ 1.6, 0.8 ], [ 0.0, 0.8 ] ],
      [ [ -1.1, 0.733 ], [ -1.833, 0.733 ], [ 1.1, 0.733 ], [ 1.833, 0.733 ], [ -0.367, 0.733 ], [ 0.367, 0.733 ] ],
      [ [ -0.92, 0.92 ], [ -1.84, 0.92 ], [ 0.92, 0.92 ], [ 1.84, 0.92 ], [ 0.0, 0.92 ] ],
      [ [ 0.0, 1.0 ], [ -1.9, 1.0 ], [ 1.9, 1.0 ] ],
      [ [ 0.0, 0.8 ], [ -2.0, 1.0 ], [ 2.0, 1.0 ] ],
      [ [ 0.0, 0.6 ], [ -2.05, 0.9 ], [ 2.05, 0.9 ] ],
      [ [ 0.0, 0.5 ], [ -2.05, 0.9 ], [ 2.05, 0.9 ] ],
      [ [ 0.0, 0.5 ], [ -2.05, 0.9 ], [ 2.05, 0.9 ] ],
      [ [ 0.0, 0.5 ], [ -1.95, 0.9 ], [ 1.95, 0.9 ] ],
      [ [ 0.0, 0.5 ], [ -1.85, 0.9 ], [ 1.85, 0.9 ] ],
      [ [ 0.0, 0.5 ], [ -1.7, 1.0 ], [ 1.7, 1.0 ] ],
      [ [ 0.0, 0.5 ], [ -1.5, 1.0 ], [ 1.5, 1.0 ] ],
      [ [ 0.0, 0.5 ], [ -1.3, 1.0 ], [ 1.3, 1.0 ] ],
      [ [ 0.0, 0.5 ], [ -1.1, 1.0 ], [ 1.1, 1.0 ] ],
      [ [ 0.0, 0.5 ], [ -0.9, 1.0 ], [ 0.9, 1.0 ] ],
      [ [ 0.0, 0.6 ], [ -0.75, 0.9 ], [ 0.75, 0.9 ] ],
      [ [ -0.5, 1.0 ], [ 0.5, 1.0 ] ],
      [ [ -0.533, 0.533 ], [ -0.0, 0.533 ], [ 0.533, 0.533 ] ],
      [ [ -0.3, 0.6 ], [ 0.3, 0.6 ] ]
    ]
  };

function updateOutlineSelector(){
	while(outlineSelector.options.length) outlineSelector.options.remove(0);
	Object.entries(outlines).forEach(([k2,v2]) => {
			v2.forEach((x)=>{x[1]*=deg;});
			var el = document.createElement("option");
			el.textContent=k2;
			el.value=k2;
			outlineSelector.appendChild(el);
    });
};

function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
	let decodedContents=JSON.parse(contents);//jsyaml.load(contents);
	outlines=decodedContents["outlines"];
	updateOutlineSelector();
	brickworks=decodedContents["brickworks"];
};
  reader.readAsText(file);
}

function displayContents(contents) {
  var element = document.getElementById('file-content');
  element.textContent = contents;
}

function drawSelectedOutline(e) {
	const canvas = document.getElementById('arcCanvas');
    const ctx = canvas.getContext('2d');
	ctx.reset();
	ctx.clearRect(0,0,canvas.width,canvas.height);
	ctx.translate(canvas.width/2,canvas.height/2);
	ctx.scale(1,1);
//	debugLog("target value= "+e.target.value);
//	debugLog("outlines[e.target.value]= "+outlines[e.target.value]);
    let key
	try {
		key=e.target.value;
	} catch (e) {}
	if (key===undefined) key="Duck";
	let [l,a,,,centroid]=TurtlePathLengthArea(outlines[key]);
	let scale=Math.sqrt(cookieCutterArea/a);
	console.log("key= "+key+", l= "+l+", a= "+a+", scale= "+scale);
	let a0=[1,0];
	let p0=[-centroid[0]*scale*5,-centroid[1]*scale*5];
    plot_segments(ctx,{segs:outlines[key],p0:p0,a0:a0,scale:scale*5});
	plot_segments(ctx,{segs:outlines[key],p0:p0,a0:a0,offs:3,scale:scale*5});
	plot_segments(ctx,{segs:outlines[key],p0:p0,a0:a0,offs:-3,scale:scale*5});
}

document.getElementById('file-input')
  .addEventListener('change', readSingleFile, false);

var outlineSelector;
function initDocument(){
	outlineSelector=document.getElementById('outline-selector');
	outlineSelector.addEventListener('change', drawSelectedOutline, false);
	updateOutlineSelector();
	drawSelectedOutline();
}

//debugLog(outlineSelector);

document.addEventListener("DOMContentLoaded", initDocument);
</script>
<div id="targetAngle" class="slider"></div> 
</body>
</html>